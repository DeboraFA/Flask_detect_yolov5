<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Detecção de Objetos com YOLO v5</title>
    <style>
        #container {
            height: 100vh;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        #video {
            width: 640px;
            height: 640px;
        }
        
        #buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        button {
            margin: 0 10px;
            padding: 10px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>

    <script>
        function startCamera() {
            // Captura o elemento de vídeo
            const video = document.getElementById('video');

            // Verifica se o navegador suporta getUserMedia
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Solicita acesso à câmera
                navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    // Define a fonte do elemento de vídeo como a câmera
                    video.srcObject = stream;
                })
                .catch(err => {
                    console.log(err);
                });
            }
        }

        function stopCamera() {
            // Captura o elemento de vídeo
            const video = document.getElementById('video');

            // Para a câmera e limpa a fonte do elemento de vídeo
            const tracks = video.srcObject.getTracks();
            tracks.forEach(track => {
                track.stop();
            });
            video.srcObject = null;
        }


        function detect() {
            // Captura o elemento de vídeo
            const video = document.getElementById('video');

            // Captura o canvas
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            // Desenha o quadro atual do vídeo no canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Converte o canvas para base64
            const image_data = canvas.toDataURL('image/jpeg');

            // Envia o base64 para o servidor via POST request
            fetch('/detect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    image: image_data.split(',')[1]
                })
            })
            .then(response => response.json())
            .then(objects => {
                // Exibe os objetos detectados na tela
                const output = document.getElementById('output');
                output.innerHTML = '';

                objects.forEach(obj => {
                    const div = document.createElement('div');
                    div.innerHTML = `Class: ${obj.class}, Confidence: ${obj.confidence.toFixed(2)}, x1: ${obj.x1.toFixed(2)}, y1: ${obj.y1.toFixed(2)}, x2: ${obj.x2.toFixed(2)}, y2: ${obj.y2.toFixed(2)}`;
                    output.appendChild(div);
                });
            })
            .catch(err => {
                console.log(err);
            });
        }

        // Inicia a câmera quando a página carrega
        window.addEventListener('load', startCamera);
    </script>
</head>
<body>
    <!-- <h1>Detecção de Objetos com YOLO v5</h1> -->
    <div align="center">
        <button onclick="startCamera()">Iniciar</button>
        <button onclick="stopCamera()">Parar</button>
    </div>

    <script
    src="{{ url_for('static', filename='script.js') }}"
    type="module"
    ></script>

    
    <div align="center">
        
    <div>
        <video id="video" width="640" height="640" autoplay onloadedmetadata="detect()"></video>
        <canvas id="canvas" width="640" height="640" style="display: none;"></canvas>
    </div>
    <div id="output"></div>
    

    </body>
    </html>
    <script>
        function startCamera() {
            // Captura o elemento de vídeo
            const video = document.getElementById('video');
    
            // Verifica se o navegador suporta getUserMedia
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Solicita acesso à câmera
                navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    // Define a fonte do elemento de vídeo como a câmera
                    video.srcObject = stream;
                })
                .catch(err => {
                    console.log(err);
                });
            }
        }
    
        function stopCamera() {
            // Captura o elemento de vídeo
            const video = document.getElementById('video');
    
            // Para a câmera e limpa a fonte do elemento de vídeo
            const tracks = video.srcObject.getTracks();
            tracks.forEach(track => {
                track.stop();
            });
            video.srcObject = null;
        }
    
    
        function detect() {
            // Captura o elemento de vídeo
            const video = document.getElementById('video');
    
            // Captura o canvas
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
    
            // Desenha o quadro atual do vídeo no canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
            // Converte o canvas para base64
            const image_data = canvas.toDataURL('image/jpeg');
    
            // Envia o base64 para o servidor via POST request
            fetch('/detect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    image: image_data.split(',')[1]
                })
            })
            .then(response => response.json())
            .then(objects => {
                // Exibe os objetos detectados na tela
                const output = document.getElementById('output');
                output.innerHTML = '';
    
                objects.forEach(obj => {
                    const div = document.createElement('div');
                    div.innerHTML = `Class: ${obj.class}, Confidence: ${obj.confidence.toFixed(2)}, x1: ${obj.x1.toFixed(2)}, y1: ${obj.y1.toFixed(2)}, x2: ${obj.x2.toFixed(2)}, y2: ${obj.y2.toFixed(2)}`;
                    output.appendChild(div);
                });
            })
            .catch(err => {
                console.log(err);
            });
            // Chama a função detect novamente em loop infinito
            setTimeout(detect, 100);
        }
    
        // Inicia a câmera e detecta objetos quando a página carrega
        window.addEventListener('load', () => {
            startCamera();
            detect();
        });
    </script>
    
    
    
    
    